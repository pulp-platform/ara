// Copyright 2021 ETH Zurich and University of Bologna.
// Solderpad Hardware License, Version 0.51, see LICENSE for details.
// SPDX-License-Identifier: SHL-0.51
//
// Author: Matheus Cavalcante <matheusd@iis.ee.ethz.ch>
//         Basile Bougenot <bbougenot@student.ethz.ch>
//         Matteo Perotti <mperotti@iis.ee.ethz.ch>

#include "float_macros.h"
#include "vector_macros.h"

// Simple random test with similar values (vector-scalar)
void TEST_CASE1(void) {
  VSET(16, e16, m1);
  double dscalar_16;
  //              -35.5312, -61.8125, -37.3125,  23.5938,  44.4688,  38.1250,
  //              -93.5000, -23.2031, -62.8125,  27.9844, -26.2344, -10.3594,
  //              -10.7109, -42.0938,  11.0625,  17.8281
  VLOAD_16(v2, 0xd071, 0xd3ba, 0xd0aa, 0x4de6, 0x518f, 0x50c4, 0xd5d8, 0xcdcd,
           0xd3da, 0x4eff, 0xce8f, 0xc92e, 0xc95b, 0xd143, 0x4988, 0x4c75);
  //                             -17.4844
  BOX_HALF_IN_DOUBLE(dscalar_16, 0xcc5f);
  asm volatile("vfrdiv.vf v4, v2, %[A]" ::[A] "f"(dscalar_16));
  //               0.4922,  0.2830,  0.4685, -0.7412, -0.3931, -0.4585,  0.1870,
  //               0.7534,  0.2783, -0.6250,  0.6665,  1.6875,  1.6328,  0.4153,
  //               -1.5801, -0.9810
  VCMP_U16(1, v4, 0x37df, 0x3486, 0x377f, 0xb9ed, 0xb64a, 0xb756, 0x31fb,
           0x3a07, 0x3474, 0xb8ff, 0x3954, 0x3ec0, 0x3e87, 0x36a5, 0xbe52,
           0xbbd8);

  VSET(16, e32, m1);
  double dscalar_32;
  //               981163.06250000, -831670.37500000, -85439.06250000,
  //               64225.75781250, -215361.43750000, -292944.75000000,
  //               396490.21875000,  954345.93750000,  241910.40625000,
  //               -62372.83593750,  391838.50000000,  263890.03125000,
  //               755217.06250000, -6653.31689453,  526939.25000000,
  //               -759232.75000000
  VLOAD_32(v2, 0x496f8ab1, 0xc94b0b66, 0xc7a6df88, 0x477ae1c2, 0xc852505c,
           0xc88f0a18, 0x48c19947, 0x4968fe9f, 0x486c3d9a, 0xc773a4d6,
           0x48bf53d0, 0x4880da41, 0x49386111, 0xc5cfea89, 0x4900a5b4,
           0xc9395c0c);
  //                              -816463.43750000
  BOX_FLOAT_IN_DOUBLE(dscalar_32, 0xc94754f7);
  asm volatile("vfrdiv.vf v4, v2, %[A]" ::[A] "f"(dscalar_32));
  //              -0.83213836,  0.98171520,  9.55609035,
  //              -12.71239853,  3.79113102,  2.78709030, -2.05922723,
  //              -0.85552144, -3.37506533,  13.09004879, -2.08367324,
  //              -3.09395337, -1.08109772,  122.71524811,
  //              -1.54944515,  1.07537961
  VCMP_U32(2, v4, 0xbf550705, 0x3f7b51af, 0x4118e5bf, 0xc14b65fc, 0x4072a1e4,
           0x40325faf, 0xc003ca60, 0xbf5b0374, 0xc0580112, 0x415170d6,
           0xc0055ae7, 0xc0460354, 0xbf8a6168, 0x42f56e35, 0xbfc65437,
           0x3f89a60a);

  VSET(16, e64, m1);
  double dscalar_64;
  //               -1436518.0384849868714809,  7616315.8933699131011963,
  //               -3920170.8619796745479107, -8788296.3276759665459394,
  //               -4048340.2138868225738406,  7863298.6869412772357464,
  //               6686376.3073008488863707,  7004262.4451152756810188,
  //               5533006.3396991230547428,  2002846.6050684414803982,
  //               -1239975.7277694121003151,  4133787.1656649876385927,
  //               2465999.3703419454395771, -4337686.8389181373640895,
  //               -5741249.6292232554405928,  1762825.0474482532590628
  VLOAD_64(v2, 0xc135eb6609da26f0, 0x415d0dcef92cf900, 0xc14de8956e555998,
           0xc160c3290a7c524f, 0xc14ee2ea1b60a4b6, 0x415dff00abf6d88c,
           0x415981aa13aad12e, 0x415ab8199c7cc4c8, 0x41551b5395bda164,
           0x413e8f9e9ae5c3f0, 0xc132eba7ba4f18a0, 0x414f89cd953482a4,
           0x4142d067af675d68, 0xc1508c05b5b0d5b3, 0xc155e6b06845319e,
           0x413ae6090c259198);
  //                               -181636.6228598635643721
  BOX_DOUBLE_IN_DOUBLE(dscalar_64, 0xc1062c24fb9df3c0);
  asm volatile("vfrdiv.vf v4, v2, %[A]" ::[A] "f"(dscalar_64));
  //               0.1264422847425051, -0.0238483573164265,  0.0463338536137523,
  //               0.0206680130126992,  0.0448669363895861, -0.0230992907800273,
  //               -0.0271651810355835, -0.0259322982659703,
  //               -0.0328278356662322, -0.0906892332144711, 0.1464840148013292,
  //               -0.0439395197625382, -0.0736563946626949, 0.0418740747326899,
  //               0.0316371233773435, -0.1030372373723578
  VCMP_U64(3, v4, 0x3fc02f42c2e6795f, 0xbf986bb42af3122b, 0x3fa7b91223effbc4,
           0x3f9529fedfd9f42e, 0x3fa6f8cc90ee127a, 0xbf97a75729d81370,
           0xbf9bd130708d0e6e, 0xbf9a8dff13d98f11, 0xbfa0cecf612b7be2,
           0xbfb73768dac16680, 0x3fc2bffcfa7aafc4, 0xbfa67f3da0c39bb5,
           0xbfb2db253e37b0f2, 0x3fa57084cb0de853, 0x3fa032bdb47d8bce,
           0xbfba60a5fcc8d2be);
};

// Simple random test with similar values (vector-scalar) (masked)
void TEST_CASE2(void) {
  VSET(16, e16, m1);
  double dscalar_16;
  //               -35.5312, -61.8125, -37.3125,  23.5938,  44.4688,  38.1250,
  //               -93.5000, -23.2031, -62.8125,  27.9844, -26.2344, -10.3594,
  //               -10.7109, -42.0938,  11.0625,  17.8281
  VLOAD_16(v2, 0xd071, 0xd3ba, 0xd0aa, 0x4de6, 0x518f, 0x50c4, 0xd5d8, 0xcdcd,
           0xd3da, 0x4eff, 0xce8f, 0xc92e, 0xc95b, 0xd143, 0x4988, 0x4c75);
  //                             -17.4844
  BOX_HALF_IN_DOUBLE(dscalar_16, 0xcc5f);
  VLOAD_8(v0, 0xAA, 0xAA);
  VCLEAR(v4);
  asm volatile("vfrdiv.vf v4, v2, %[A], v0.t" ::[A] "f"(dscalar_16));
  //                0.0000,  0.2830,  0.0000, -0.7412,  0.0000, -0.4585, 0.0000,
  //                0.7534,  0.0000, -0.6250,  0.0000,  1.6875,  0.0000, 0.4153,
  //                0.0000, -0.9810
  VCMP_U16(4, v4, 0x0, 0x3486, 0x0, 0xb9ed, 0x0, 0xb756, 0x0, 0x3a07, 0x0,
           0xb8ff, 0x0, 0x3ec0, 0x0, 0x36a5, 0x0, 0xbbd8);

  VSET(16, e32, m1);
  double dscalar_32;
  //                981163.06250000, -831670.37500000, -85439.06250000,
  //                64225.75781250, -215361.43750000, -292944.75000000,
  //                396490.21875000,  954345.93750000,  241910.40625000,
  //                -62372.83593750,  391838.50000000,  263890.03125000,
  //                755217.06250000, -6653.31689453,  526939.25000000,
  //                -759232.75000000
  VLOAD_32(v2, 0x496f8ab1, 0xc94b0b66, 0xc7a6df88, 0x477ae1c2, 0xc852505c,
           0xc88f0a18, 0x48c19947, 0x4968fe9f, 0x486c3d9a, 0xc773a4d6,
           0x48bf53d0, 0x4880da41, 0x49386111, 0xc5cfea89, 0x4900a5b4,
           0xc9395c0c);
  //                              -816463.43750000
  BOX_FLOAT_IN_DOUBLE(dscalar_32, 0xc94754f7);
  VLOAD_8(v0, 0xAA, 0xAA);
  VCLEAR(v4);
  asm volatile("vfrdiv.vf v4, v2, %[A], v0.t" ::[A] "f"(dscalar_32));
  //                0.00000000,  0.98171520,  0.00000000, -12.71239853,
  //                0.00000000,  2.78709030,  0.00000000, -0.85552144,
  //                0.00000000,  13.09004879,  0.00000000, -3.09395337,
  //                0.00000000,  122.71524811,  0.00000000,  1.07537961
  VCMP_U32(5, v4, 0x0, 0x3f7b51af, 0x0, 0xc14b65fc, 0x0, 0x40325faf, 0x0,
           0xbf5b0374, 0x0, 0x415170d6, 0x0, 0xc0460354, 0x0, 0x42f56e35, 0x0,
           0x3f89a60a);

  VSET(16, e64, m1);
  double dscalar_64;
  //                -1436518.0384849868714809,  7616315.8933699131011963,
  //                -3920170.8619796745479107, -8788296.3276759665459394,
  //                -4048340.2138868225738406,  7863298.6869412772357464,
  //                6686376.3073008488863707,  7004262.4451152756810188,
  //                5533006.3396991230547428,  2002846.6050684414803982,
  //                -1239975.7277694121003151,  4133787.1656649876385927,
  //                2465999.3703419454395771, -4337686.8389181373640895,
  //                -5741249.6292232554405928,  1762825.0474482532590628
  VLOAD_64(v2, 0xc135eb6609da26f0, 0x415d0dcef92cf900, 0xc14de8956e555998,
           0xc160c3290a7c524f, 0xc14ee2ea1b60a4b6, 0x415dff00abf6d88c,
           0x415981aa13aad12e, 0x415ab8199c7cc4c8, 0x41551b5395bda164,
           0x413e8f9e9ae5c3f0, 0xc132eba7ba4f18a0, 0x414f89cd953482a4,
           0x4142d067af675d68, 0xc1508c05b5b0d5b3, 0xc155e6b06845319e,
           0x413ae6090c259198);
  //                               -181636.6228598635643721
  BOX_DOUBLE_IN_DOUBLE(dscalar_64, 0xc1062c24fb9df3c0);
  VLOAD_8(v0, 0xAA, 0xAA);
  VCLEAR(v4);
  asm volatile("vfrdiv.vf v4, v2, %[A], v0.t" ::[A] "f"(dscalar_64));
  //                0.0000000000000000, -0.0238483573164265, 0.0000000000000000,
  //                0.0206680130126992,  0.0000000000000000,
  //                -0.0230992907800273,  0.0000000000000000,
  //                -0.0259322982659703,  0.0000000000000000,
  //                -0.0906892332144711,  0.0000000000000000,
  //                -0.0439395197625382,  0.0000000000000000,
  //                0.0418740747326899,  0.0000000000000000, -0.1030372373723578
  VCMP_U64(6, v4, 0x0, 0xbf986bb42af3122b, 0x0, 0x3f9529fedfd9f42e, 0x0,
           0xbf97a75729d81370, 0x0, 0xbf9a8dff13d98f11, 0x0, 0xbfb73768dac16680,
           0x0, 0xbfa67f3da0c39bb5, 0x0, 0x3fa57084cb0de853, 0x0,
           0xbfba60a5fcc8d2be);
};

int main(void) {
  enable_vec();
  enable_fp();
  // Change RM to RTZ since there are issues with FDIV + RNE in fpnew
  // Update: there are issues also with RTZ...
  CHANGE_RM(RM_RTZ);

  TEST_CASE1();
  TEST_CASE2();

  EXIT_CHECK();
}
